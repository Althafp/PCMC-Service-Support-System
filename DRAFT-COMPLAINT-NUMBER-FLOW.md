# ğŸ“‹ Draft Complaint Number Flow - Complete Guide

## âœ… **COMPLETE COMPLAINT NUMBER LIFECYCLE**

---

## ğŸ”„ **The Complete Flow:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: NEW REPORT CREATED                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Complaint Number: COMP-1760642449787        â”‚
â”‚ (Auto-generated with timestamp)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SAVE AS DRAFT   â”‚   â”‚ SUBMIT DIRECTLY      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Number changes  â”‚   â”‚ Number stays         â”‚
â”‚ to:             â”‚   â”‚ COMP-1760642449787   â”‚
â”‚ DRAFT-user123-  â”‚   â”‚                      â”‚
â”‚ 1760642449787   â”‚   â”‚ Status: submitted    â”‚
â”‚                 â”‚   â”‚                      â”‚
â”‚ Status: draft   â”‚   â”‚ Goes to Team Leader  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â†“
         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚ TEAM LEADER APPROVES â”‚
         â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚            â”‚ Number changes to:   â”‚
         â”‚            â”‚ COMP-00001           â”‚
         â”‚            â”‚ (Sequential)         â”‚
         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: CONTINUE DRAFT                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User opens draft from Drafts page           â”‚
â”‚ Sees: DRAFT-user123-1760642449787           â”‚
â”‚                                             â”‚
â”‚ User can:                                   â”‚
â”‚ A) Keep as is                               â”‚
â”‚ B) Change to custom number (e.g. COMP-12345)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: SUBMIT DRAFT                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ System checks complaint number format:      â”‚
â”‚                                             â”‚
â”‚ IF starts with "DRAFT-":                    â”‚
â”‚   â†’ Convert to COMP-{timestamp}             â”‚
â”‚   â†’ DRAFT-user123-... becomes COMP-17606... â”‚
â”‚                                             â”‚
â”‚ IF custom number (e.g. COMP-12345):         â”‚
â”‚   â†’ Keep custom number                      â”‚
â”‚   â†’ Stays as COMP-12345                     â”‚
â”‚                                             â”‚
â”‚ Status: submitted                           â”‚
â”‚ Goes to Team Leader                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: TEAM LEADER APPROVAL                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Current: COMP-1760642... or COMP-12345      â”‚
â”‚                                             â”‚
â”‚ Team Leader clicks "Approve"                â”‚
â”‚ System assigns sequential number:           â”‚
â”‚ COMP-00001 (or next available)              â”‚
â”‚                                             â”‚
â”‚ Replaces temporary number                   â”‚
â”‚ Status: approved                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **Detailed Examples:**

### **Example 1: Direct Submission**
```
1. New Report â†’ COMP-1760642449787
2. Submit â†’ COMP-1760642449787 (unchanged)
3. Approve â†’ COMP-00001 (sequential)
```

### **Example 2: Save as Draft, Continue, Submit**
```
1. New Report â†’ COMP-1760642449787
2. Save Draft â†’ DRAFT-user123-1760642449787
3. Continue â†’ DRAFT-user123-1760642449787
4. Submit â†’ COMP-1760642500000 (new COMP- format)
5. Approve â†’ COMP-00002 (sequential)
```

### **Example 3: Save as Draft, Edit Number, Submit**
```
1. New Report â†’ COMP-1760642449787
2. Save Draft â†’ DRAFT-user123-1760642449787
3. Continue â†’ DRAFT-user123-1760642449787
4. User changes to â†’ COMP-CUSTOM-001
5. Submit â†’ COMP-CUSTOM-001 (keeps custom)
6. Approve â†’ COMP-00003 (sequential)
```

---

## ğŸ’» **Code Implementation:**

### **Save as Draft:**
```javascript
// In handleSaveDraft()
if (!isDraftMode) {
  const timestamp = Date.now();
  draftComplaintNo = `DRAFT-${user.id}-${timestamp}`;
}
// Saves: DRAFT-abc-123-1760642449787
```

### **Submit Draft:**
```javascript
// In handleSubmit()
let finalComplaintNo = formData.complaint_no;

if (isDraftMode && finalComplaintNo?.startsWith('DRAFT-')) {
  // Convert DRAFT- to COMP- format
  const timestamp = Date.now();
  finalComplaintNo = `COMP-${timestamp}`;
  console.log('Converting draft to submission format:', finalComplaintNo);
}
// Result: COMP-1760642500000
```

### **Team Leader Approval:**
```javascript
// In handleApproval() - Team Leader page
if (action === 'approve') {
  const { data: sequentialNumber } = await supabase
    .rpc('get_next_complaint_number');
  
  updateData.complaint_no = sequentialNumber;
  // Result: COMP-00001, COMP-00002, etc.
}
```

---

## ğŸ¯ **Visual Indicator:**

### **In Step 1 Complaint Number Field:**

**If continuing draft:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Complaint Number *                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ DRAFT-user123-1760642449787    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ âš ï¸ Draft format - Will convert to  â”‚
â”‚    COMP- format on submit          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**If custom number:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Complaint Number *                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ COMP-12345                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ âœ“ COMP-12345                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ **Complete Workflow Examples:**

### **Scenario A: Quick Report (No Draft)**
```
Technician:
  1. New Report â†’ COMP-1760642449787
  2. Fill all steps
  3. Submit â†’ COMP-1760642449787

Team Leader:
  4. Review report
  5. Approve â†’ COMP-00001 âœ…
```

### **Scenario B: Save Draft, Continue Later**
```
Day 1 - Technician:
  1. New Report â†’ COMP-1760642449787
  2. Fill Steps 1-3
  3. Click Back â†’ Save as Draft
  4. Number becomes: DRAFT-user123-1760642449787
  5. Saved in database

Day 2 - Technician:
  6. Open Drafts
  7. Click "Continue"
  8. Sees: DRAFT-user123-1760642449787
  9. Can change to: COMP-MYCUSTOM-001
  10. Complete remaining steps
  11. Submit
  12. If kept DRAFT- format â†’ Converts to COMP-1760642500000
      If changed to COMP-MYCUSTOM-001 â†’ Keeps COMP-MYCUSTOM-001

Team Leader:
  13. Review report
  14. Approve â†’ COMP-00002 âœ…
```

---

## ğŸ—„ï¸ **Database Changes:**

### **Draft Creation:**
```sql
INSERT INTO service_reports 
(complaint_no, status, ...) 
VALUES ('DRAFT-user123-1760642449787', 'draft', ...);
```

### **Continue Draft (Submit):**
```sql
UPDATE service_reports 
SET 
  complaint_no = 'COMP-1760642500000',  -- Converted!
  status = 'submitted',
  approval_status = 'pending'
WHERE id = [draft_id];
```

### **Team Leader Approval:**
```sql
UPDATE service_reports 
SET 
  complaint_no = 'COMP-00001',  -- Sequential!
  status = 'approved',
  approval_status = 'approve',
  tl_signature = [...],
  approved_at = NOW()
WHERE id = [report_id];
```

---

## âœ… **Summary:**

| Stage | Complaint Number Format | Example |
|-------|------------------------|---------|
| New Report | `COMP-{timestamp}` | COMP-1760642449787 |
| Save as Draft | `DRAFT-{userId}-{timestamp}` | DRAFT-user123-1760642449787 |
| Continue Draft | Same as saved | DRAFT-user123-1760642449787 |
| User can edit | Any format | COMP-CUSTOM-001 |
| Submit Draft | `COMP-{timestamp}` or custom | COMP-1760642500000 |
| Approved | `COMP-{5-digit-sequential}` | COMP-00001 |

---

## ğŸ¯ **Key Points:**

1. âœ… **DRAFT-** format is temporary (only while draft)
2. âœ… User can change complaint number in draft
3. âœ… On submit, DRAFT- converts to COMP-
4. âœ… Custom numbers (COMP-12345) are preserved
5. âœ… Team Leader approval assigns official sequential number
6. âœ… Sequential number (COMP-00001) is final and permanent

---

## ğŸ§ª **Test the Flow:**

### **Test 1: Draft â†’ Submit Conversion**
```
1. New Report
2. Save as Draft
3. Go to Drafts page
4. See: DRAFT-user123-...
5. Click "Continue"
6. Check Step 1: Shows DRAFT-...
7. Complete report and Submit
8. Check database: Should be COMP-... (not DRAFT-)
```

### **Test 2: Edit Draft Number**
```
1. Continue a draft
2. Change complaint number from DRAFT-... to COMP-MYTEST
3. Submit
4. Check database: Should be COMP-MYTEST
5. Team Leader approves
6. Check database: Should be COMP-00001 (sequential replaces custom)
```

---

## ğŸ“ **Console Logs:**

**When submitting a draft:**
```
ğŸ“ Converting draft complaint number to submission format: COMP-1760642500000
```

**When submitting with custom number:**
```
(No conversion message - keeps custom number)
```

**When team leader approves:**
```
âœ… Assigned sequential complaint number: COMP-00001
```

---

## ğŸ‰ **Complete!**

Your complaint number flow now has:
- âœ… DRAFT- format for saved drafts
- âœ… Auto-conversion to COMP- on submit
- âœ… User can edit to custom number
- âœ… Sequential numbering on approval
- âœ… Clear visual indicators
- âœ… Proper format transitions

**The complaint number lifecycle is fully implemented!** ğŸ“Šâœ…

